---
title: "openair_data_import_and_test_1"
author: "Andy Bean"
date: "1/21/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Setup and Import Data

```{r ukair}
#Std Libraries
library(openair); #vis pkg
library(tidyverse); #helps vis pkg
library(worldmet); #met pkg

####Get Germany AQ Data
library(dplyr); #data manip fxns
library(saqgetr); #euro pkg

#view all sites and sort down to desired location
sites_dat <- get_saq_sites();
de_sites <- filter(sites_dat, country == 'germany');
berlin_sites <- filter(de_sites, latitude > 52.3 & latitude < 52.5 & longitude > 13.4 & longitude < 13.6)

#see this
head(de_sites)

#let's test with Blankenfelde-Mahlow
prac_dat <- get_saq_observations(
    site = "debb086",
    start = 2011,
    end = 2015,
    verbose = TRUE
)

####Get Germany MET Data
#first find a station near the lat/long of the aq site
#the next fxn produces a map, don't run if not needed

#getMeta(lat = 52.54, lon = 13.34, returnMap = TRUE)

#there is only one site for Berlin, so we'll take that 

de_met <- importNOAA(code = "103850-99999", year = 2011:2015);

#you can then merge the data together by date as noted in documentation

#OPTION 1: subset and pivot
#cut irrelevant rows
new_prac_dat <- subset(prac_dat, select = -c(date_end, site, validity, summary, unit));

#first mutate the extracted pollutant data
prac_dat2 <- pivot_wider(
  new_prac_dat,
  id_cols = c(date, process),
  names_from = variable,
  values_from = value,
  values_fill = NA
)
#not quite perfect but very close. What are the different processes and can they be averaged?

#OPTION 2: saq_clean

prac_dat3 <- prac_dat %>% 
  saq_clean_observations(summary = "hour", valid_only = TRUE, spread = TRUE);

#that works well but the processes disappeared

####Append and Confirm
#now append the data
aq_berlin1 <- left_join(
    de_met,
    prac_dat3,
    by = "date"
)

#compare to basic data from text example as this has the ideal formatting
base_dat <- importAURN(site = "my1", year = 2000:2005);

head(base_dat)
head(aq_berlin1)

```

## Practicing Plots with my1

###Wind Rose

```{r}
#plot a windrose for everything
windRose(aq_berlin1)

#plot by year
windRose(aq_berlin1, type = "year", layout = c(3, 2))

#plot by pm10 (the type function is useful!)
windRose(aq_berlin1, type = "pm10", layout = c(3, 2))
```

###Pollution Rose
```{r}
#basic example for nox
pollutionRose(aq_berlin1, pollutant = "nox")

#link with s02 using type
pollutionRose(aq_berlin1, pollutant = "nox", type = "no2", layout = c(4, 1))

#segment and normalize
pollutionRose(aq_berlin1, pollutant = "nox", seg = 1, normalise = TRUE)
    #seg = 1 removes the spaces between the bars
    #normalize makes the length of all bars the same to see pollutant proportions more clearly
```
###Polar Frequencies
```{r}
#Basic example, a more detailed wind description
polarFreq(aq_berlin1)

#bin by year
polarFreq(aq_berlin1, type = "year")

#add pollutant
polarFreq(aq_berlin1, type = "year", pollutant = "pm10", statistic = "mean", min.bin = 2)
# we can see in detail how high concentrations came from SE in 2000, but moved north and decreased in frequency starting in 2003
```
###Percentile Rose
```{r}
#basic example, the concentrations of the pollutant are marked on the rings and the percentiles are shaded
percentileRose(aq_berlin1, pollutant = "pm10")

#can also customize the percentiles and smooth the plot
percentileRose(aq_berlin1, pollutant = "pm10", percentile = c(25, 50, 75, 90, 95, 99), col = "jet", smooth = TRUE)
#we see the pm10 is pretty even from all directions
```
###Polar Plot
```{r}
#basic polar plot
polarPlot(aq_berlin1, pollutant = "pm10")
# so we see that there is only a high conc from the sw when the wind speed is higher than usual
```

###Polar Annulus
```{r}
#make polar annuli for all data, by season, by weekday, and by hour in a day

#polarAnnulus(aq_berlin1, poll = "pm10", period = "trend", main = "Trend")
polarAnnulus(aq_berlin1, poll = "pm10", period = "season", main = "Season")
polarAnnulus(aq_berlin1, poll = "pm10", period = "weekday", main = "Weekday")
polarAnnulus(aq_berlin1, poll = "pm10", period = "hour", main = "Hour")

# shows direction of pollution over time from inner most to outermost ring

```

###Time Series Plots
```{r}
#unfinished
```


###Temporal Variations
```{r}
#unfinished
```

